"use strict";var CHESS=CHESS||{};CHESS.nag_code={0:{symbol:"",desc:""},1:{symbol:"!",desc:"A very good move"},2:{symbol:"?",desc:"A mistake"},3:{symbol:"!!",desc:"An excellent move"},4:{symbol:"??",desc:"A blunder"},5:{symbol:"!?",desc:"A move deserving attention"},6:{symbol:"?!",desc:"A dubious move"},7:{symbol:"only_move.svg",desc:"Forced move"},8:{symbol:"only_move.svg",desc:"Only move"},9:{symbol:"???",desc:"Worst move"},10:{symbol:"=",desc:"Even"},11:{symbol:"=",desc:"Equal chances, quiet position"},12:{symbol:"=",desc:"Equal chances, active position"},13:{symbol:"unclear.svg",desc:"Unclear"},14:{symbol:"plus_over_equal.svg",desc:"White stands slightly better"},15:{symbol:"equal_over_plus.svg",desc:"Black stands slightly better"},16:{symbol:"plus_over_minus.svg",desc:"White has the upper hand"},17:{symbol:"minus_over_plus.svg",desc:"Black has the upper hand"},18:{symbol:"plus_minus.svg",desc:"White has a decisive advantage"},19:{symbol:"minus_plus.svg",desc:"Black has a decisive advantage"}},CHESS.util={},CHESS.util.createPosition=function(a){var b=function(){},c=function(){};c.prototype=b;var d=new c;return void 0!==a&&this.setPosition(d,a),d},CHESS.util.setPosition=function(a,b){var c,d,e,f=[],g="",h=0,i="",j="",k="",l=["a","b","c","d","e","f","g","h"],m=0,n=0,o=0;for(c=b.split(" "),d=c[0],e=c[2],f=d.split("/"),a.en_passant=c[3],a.white_to_move="w"===c[1],"-"===e?(a.gs_castle_kside_w=!1,a.gs_castle_qside_w=!1,a.gs_castle_kside_b=!1,a.gs_castle_qside_b=!1):(e.indexOf("K")>=0&&(a.gs_castle_kside_w=!0),e.indexOf("Q")>=0&&(a.gs_castle_qside_w=!0),e.indexOf("k")>=0&&(a.gs_castle_kside_b=!0),e.indexOf("q")>=0&&(a.gs_castle_qside_b=!0)),a.position_array=[["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"]],a.piecebox_array=[["-","wk","wq","wr","wb","wn","wp","-"],["-","bk","bq","br","bb","bn","bp","-"]],a.moves=0,a.last_move={},m=0;m<f.length;m+=1)for(n=0;n<f[m].length;n+=1){for(g=f[m].charAt(n),o=0;o<a.position_array[m].length;o+=1)"-"===a.position_array[m][o]&&(h=o,o=a.position_array[m].length);if(/[0-9]/.test(g))for(o=0;o<parseInt(g,10);o+=1)a.position_array[m][o+h]="";else i="w",/[a-z]/.test(g)&&(i="b"),j=g.toLowerCase(),k="","p"===j&&(k=l[h]),a.position_array[m][h]=i+j+k}},CHESS.util.getFEN=function(a){var b,c=[],d="",e="",f=[],g="",h="",i=0,j=0,k=0;for(i=0;i<a.position_array.length;i+=1){for(f[i]="",j=0;j<a.position_array[i].length;j+=1)h=a.position_array[i][j],""===h?k+=1:(k>0&&(f[i]+=k+"",k=0),g=h.substr(0,1),h=h.substr(1,1),"w"===g&&(h=h.toUpperCase()),f[i]+=h);k>0&&(f[i]+=k+"",k=0)}return b=f.join("/"),c.push(b),c.push(a.white_to_move?"w":"b"),d="-",(a.gs_castle_kside_w||a.gs_castle_qside_w||a.gs_castle_kside_b||a.gs_castle_qside_b)&&(a.gs_castle_kside_w&&(d+="K"),a.gs_castle_qside_w&&(d+="Q"),a.gs_castle_kside_b&&(d+="k"),a.gs_castle_qside_b&&(d+="q")),c.push(d),e=""===a.en_passant?"-":a.en_passant,c.push(e),c.push("0 1"),c.join(" ")},CHESS.util.isLegal=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;if(e=this.getArrayPosition(b),f=this.getArrayPosition(c),!e||!f)return!1;if(g=parseInt(e.substr(0,1)),h=parseInt(e.substr(1,1)),i=parseInt(f.substr(0,1)),j=parseInt(f.substr(1,1)),k=a.position_array[h][g],l=a.position_array[j][i],m=k.substr(1,1),n=k.substr(0,1),o=!1,a.white_to_move&&"b"===n||!a.white_to_move&&"w"===n)return!1;if(l.substr(0,1)===k.substr(0,1))return!1;if("p"===m){if(h===j)return!1;if("w"===n&&j>h||"b"===n&&h>j)return!1;if(!(1===Math.abs(h-j)||2===Math.abs(h-j)&&("w"===n&&6===h&&""===a.position_array[5][g]||"b"===n&&1===h&&""===a.position_array[2][g])))return!1;if(0===Math.abs(g-i)&&""!==a.position_array[j][i])return!1;if(Math.abs(g-i)>0&&(p=""!==l.substr(0,1)&&l.substr(0,1)!==n,o=a.en_passant===this.reverseArrayPosition(j+""+i),1!==Math.abs(g-i)||1!==Math.abs(h-j)||!p&&!o))return!1}if("k"===m)if(2===Math.abs(g-i)){if("w"===n)if("g1"===c&&a.gs_castle_kside_w&&""===a.position_array[7][5]&&""===a.position_array[7][6]){if(this.isSquareAttacked(a.position_array,4,7,"w"))return!1;if(this.isSquareAttacked(a.position_array,5,7,"w"))return!1;if(this.isSquareAttacked(a.position_array,6,7,"w"))return!1}else{if("c1"!==c||!a.gs_castle_qside_w||""!==a.position_array[7][1]||""!==a.position_array[7][2]||""!==a.position_array[7][3])return!1;if(this.isSquareAttacked(a.position_array,2,7,"w"))return!1;if(this.isSquareAttacked(a.position_array,3,7,"w"))return!1;if(this.isSquareAttacked(a.position_array,4,7,"w"))return!1}else if("b"===n)if("g8"===c&&a.gs_castle_kside_b&&""===a.position_array[0][5]&&""===a.position_array[0][6]){if(this.isSquareAttacked(a.position_array,4,0,"b"))return!1;if(this.isSquareAttacked(a.position_array,5,0,"b"))return!1;if(this.isSquareAttacked(a.position_array,6,0,"b"))return!1}else{if("c8"!==c||!a.gs_castle_qside_b||""!==a.position_array[0][1]||""!==a.position_array[0][2]||""!==a.position_array[0][3])return!1;if(this.isSquareAttacked(a.position_array,2,0,"b"))return!1;if(this.isSquareAttacked(a.position_array,3,0,"b"))return!1;if(this.isSquareAttacked(a.position_array,4,0,"b"))return!1}}else if(!(Math.abs(g-i)<2&&Math.abs(h-j)<2))return!1;if("n"===m&&!(1===Math.abs(g-i)&&2===Math.abs(h-j)||2===Math.abs(g-i)&&1===Math.abs(h-j)))return!1;if("r"===m&&g!==i&&h!==j)return!1;if("b"===m&&Math.abs(g-i)!==Math.abs(h-j))return!1;if("q"===m&&Math.abs(g-i)!==Math.abs(h-j)&&g!==i&&h!==j)return!1;if("q"===m||"b"===m||"r"===m)for(d=0,q=g-i,r=h-j,s=0,t=0,0>q?s=1:q>0&&(s=-1),0>r?t=1:r>0&&(t=-1),d=1;!(parseInt(g)+d*s===i&&parseInt(h)+d*t===j||d>8);){if(""!==a.position_array[parseInt(h)+d*t][parseInt(g)+d*s])return!1;d+=1}return u=this.clonePositionArray(a.position_array),u[f.substr(1,1)][f.substr(0,1)]=u[e.substr(1,1)][e.substr(0,1)],u[e.substr(1,1)][e.substr(0,1)]="",o&&(u[e.substr(1,1)][f.substr(0,1)]=""),this.isCheck(u,n)?!1:!0},CHESS.util.isCheck=function(a,b){var c,d,e=0,f=0;for(c=0;8>c;c++)for(d=0;8>d;d++)a[c][d]===b+"k"&&(e=d,f=c);return this.isSquareAttacked(a,e,f,b)?!0:!1},CHESS.util.isMate=function(a){var b,c,d,e,f,g,h=a.white_to_move?"w":"b",i=0,j=0,k=this.clonePositionArray(a.position_array);for(b=0;8>b;b++)for(c=0;8>c;c++)k[b][c]===h+"k"&&(i=c,j=b);if(d=this.getAttacker(k,i,j,h),""===d)return!1;if(k[j][i]="",j>0&&k[j-1][i].substr(0,1)!==h&&!this.isSquareAttacked(k,i,j-1,h))return!1;if(7>j&&k[j+1][i].substr(0,1)!==h&&!this.isSquareAttacked(k,i,j+1,h))return!1;if(i>0&&k[j][i-1].substr(0,1)!==h&&!this.isSquareAttacked(k,i-1,j,h))return!1;if(7>i&&k[j][i+1].substr(0,1)!==h&&!this.isSquareAttacked(k,i+1,j,h))return!1;if(i>0&&j>0&&k[j-1][i-1].substr(0,1)!==h&&!this.isSquareAttacked(k,i-1,j-1,h))return!1;if(7>i&&j>0&&k[j-1][i+1].substr(0,1)!==h&&!this.isSquareAttacked(k,i+1,j-1,h))return!1;if(i>0&&7>j&&k[j+1][i-1].substr(0,1)!==h&&!this.isSquareAttacked(k,i-1,j+1,h))return!1;if(7>i&&7>j&&k[j+1][i+1].substr(0,1)!==h&&!this.isSquareAttacked(k,i+1,j+1,h))return!1;k[j][i]=h+"k",e=parseInt(d.substr(1,1)),f=parseInt(d.substr(0,1));var l="b";if("b"===h&&(l="w"),g=this.getAttacker(k,e,f,l),""!==g){var m=this.reverseArrayPosition(g),n=this.reverseArrayPosition(d);if(this.isLegal(a,m,n))return!1}var o=k[f][e].substr(1,1);if(("r"===o||"b"===o||"q"===o)&&(Math.abs(i-e)>1||Math.abs(j-f)>1)){var p=e-i,q=f-j,r=0,s=0;p>0&&(r=1),q>0&&(s=1),0>p&&(r=-1),0>q&&(s=-1);var t=i+r,u=j+s;for(k[j][i]=l+"k";t!==e||u!==f;){if(this.isSquareBlockable(k,t,u,l))return!1;t+=r,u+=s}}if("p"===o){if("w"===h&&3===f&&a.en_passant===this.reverseArrayPosition(f-1+""+e)){if(e>0&&"wp"===k[3][e-1].substr(0,2))return!1;if(7>e&&"wp"===k[3][e+1].substr(0,2))return!1}if("b"===h&&4===f&&a.en_passant===this.reverseArrayPosition(f+1+""+e)){if(e>0&&"bp"===k[4][e-1].substr(0,2))return!1;if(7>e&&"bp"===k[4][e+1].substr(0,2))return!1}}return!0},CHESS.util.isSquareAttacked=function(a,b,c,d){var e,f;if(b=parseInt(b),c=parseInt(c),c>0&&b>1&&"n"===a[c-1][b-2].substr(1,1)&&a[c-1][b-2].substr(0,1)!==d)return!0;if(c>0&&6>b&&"n"===a[c-1][b+2].substr(1,1)&&a[c-1][b+2].substr(0,1)!==d)return!0;if(7>c&&b>1&&"n"===a[c+1][b-2].substr(1,1)&&a[c+1][b-2].substr(0,1)!==d)return!0;if(7>c&&6>b&&"n"===a[c+1][b+2].substr(1,1)&&a[c+1][b+2].substr(0,1)!==d)return!0;if(c>1&&b>0&&"n"===a[c-2][b-1].substr(1,1)&&a[c-2][b-1].substr(0,1)!==d)return!0;if(c>1&&7>b&&"n"===a[c-2][b+1].substr(1,1)&&a[c-2][b+1].substr(0,1)!==d)return!0;if(6>c&&b>0&&"n"===a[c+2][b-1].substr(1,1)&&a[c+2][b-1].substr(0,1)!==d)return!0;if(6>c&&7>b&&"n"===a[c+2][b+1].substr(1,1)&&a[c+2][b+1].substr(0,1)!==d)return!0;for(e=1;8>b+e;){if(f=a[c][b+e],""!==f&&f.substr(0,1)!==d&&("r"===f.substr(1,1)||"q"===f.substr(1,1)||1===e&&"k"===f.substr(1,1)))return!0;if(""!==f)break;e+=1}for(e=1;b-e>=0;){if(f=a[c][b-e],""!==f&&f.substr(0,1)!==d&&("r"===f.substr(1,1)||"q"===f.substr(1,1)||1===e&&"k"===f.substr(1,1)))return!0;if(""!==f)break;e+=1}for(e=1;c-e>=0;){if(f=a[c-e][b],""!==f&&f.substr(0,1)!==d&&("r"===f.substr(1,1)||"q"===f.substr(1,1)||1===e&&"k"===f.substr(1,1)))return!0;if(""!==f)break;e+=1}for(e=1;8>c+e;){if(f=a[c+e][b],""!==f&&f.substr(0,1)!==d&&("r"===f.substr(1,1)||"q"===f.substr(1,1)||1===e&&"k"===f.substr(1,1)))return!0;if(""!==f)break;e+=1}for(e=1;8>b+e&&c-e>=0;){if(f=a[c-e][b+e],""!==f&&f.substr(0,1)!==d&&("q"===f.substr(1,1)||"b"===f.substr(1,1)||1===e&&"k"===f.substr(1,1)))return!0;if(""!==f)break;e+=1}for(e=1;8>b+e&&8>c+e;){if(f=a[c+e][b+e],""!==f&&f.substr(0,1)!==d&&("q"===f.substr(1,1)||"b"===f.substr(1,1)||1===e&&"k"===f.substr(1,1)))return!0;if(""!==f)break;e+=1}for(e=1;b-e>=0&&8>c+e;){if(f=a[c+e][b-e],""!==f&&f.substr(0,1)!==d&&("q"===f.substr(1,1)||"b"===f.substr(1,1)||1===e&&"k"===f.substr(1,1)))return!0;if(""!==f)break;e+=1}for(e=1;b-e>=0&&c-e>=0;){if(f=a[c-e][b-e],""!==f&&f.substr(0,1)!==d&&("q"===f.substr(1,1)||"b"===f.substr(1,1)||1===e&&"k"===f.substr(1,1)))return!0;if(""!==f)break;e+=1}if("w"===d){if(b-1>=0&&c-1>=0&&(f=a[c-1][b-1],""!==f&&f.substr(0,1)!==d&&"p"===f.substr(1,1)))return!0;if(8>b+1&&c-1>=0&&(f=a[c-1][b+1],""!==f&&f.substr(0,1)!==d&&"p"===f.substr(1,1)))return!0}else{if(b-1>=0&&8>c+1&&(f=a[c+1][b-1],""!==f&&f.substr(0,1)!==d&&"p"===f.substr(1,1)))return!0;if(8>b+1&&8>c+1&&(f=a[c+1][b+1],""!==f&&f.substr(0,1)!==d&&"p"===f.substr(1,1)))return!0}return!1},CHESS.util.isSquareBlockable=function(a,b,c,d){var e,f;if(b=parseInt(b),c=parseInt(c),c>0&&b>1&&"n"===a[c-1][b-2].substr(1,1)&&a[c-1][b-2].substr(0,1)!==d)return!0;if(c>0&&6>b&&"n"===a[c-1][b+2].substr(1,1)&&a[c-1][b+2].substr(0,1)!==d)return!0;if(7>c&&b>1&&"n"===a[c+1][b-2].substr(1,1)&&a[c+1][b-2].substr(0,1)!==d)return!0;if(7>c&&6>b&&"n"===a[c+1][b+2].substr(1,1)&&a[c+1][b+2].substr(0,1)!==d)return!0;if(c>1&&b>0&&"n"===a[c-2][b-1].substr(1,1)&&a[c-2][b-1].substr(0,1)!==d)return!0;if(c>1&&7>b&&"n"===a[c-2][b+1].substr(1,1)&&a[c-2][b+1].substr(0,1)!==d)return!0;if(6>c&&b>0&&"n"===a[c+2][b-1].substr(1,1)&&a[c+2][b-1].substr(0,1)!==d)return!0;if(6>c&&7>b&&"n"===a[c+2][b+1].substr(1,1)&&a[c+2][b+1].substr(0,1)!==d)return!0;for(e=1;8>b+e;){if(f=a[c][b+e],""!==f&&f.substr(0,1)!==d&&("r"===f.substr(1,1)||"q"===f.substr(1,1)))return!0;if(""!==f)break;e+=1}for(e=1;b-e>=0;){if(f=a[c][b-e],""!==f&&f.substr(0,1)!==d&&("r"===f.substr(1,1)||"q"===f.substr(1,1)))return!0;if(""!==f)break;e+=1}for(e=1;c-e>=0;){if(f=a[c-e][b],""!==f&&f.substr(0,1)!==d&&("r"===f.substr(1,1)||"q"===f.substr(1,1)))return!0;if(""!==f)break;e+=1}for(e=1;8>c+e;){if(f=a[c+e][b],""!==f&&f.substr(0,1)!==d&&("r"===f.substr(1,1)||"q"===f.substr(1,1)))return!0;if(""!==f)break;e+=1}for(e=1;8>b+e&&c-e>=0;){if(f=a[c-e][b+e],""!==f&&f.substr(0,1)!==d&&("q"===f.substr(1,1)||"b"===f.substr(1,1)))return!0;if(""!==f)break;e+=1}for(e=1;8>b+e&&8>c+e;){if(f=a[c+e][b+e],""!==f&&f.substr(0,1)!==d&&("q"===f.substr(1,1)||"b"===f.substr(1,1)))return!0;if(""!==f)break;e+=1}for(e=1;b-e>=0&&8>c+e;){if(f=a[c+e][b-e],""!==f&&f.substr(0,1)!==d&&("q"===f.substr(1,1)||"b"===f.substr(1,1)))return!0;if(""!==f)break;e+=1}for(e=1;b-e>=0&&c-e>=0;){if(f=a[c-e][b-e],""!==f&&f.substr(0,1)!==d&&("q"===f.substr(1,1)||"b"===f.substr(1,1)))return!0;if(""!==f)break;e+=1}if("w"===d){if(c-1>=0&&(f=a[c-1][b],""!==f&&f.substr(0,1)!==d&&"p"===f.substr(1,1)))return!0;if(3===c&&""===a[2][b]&&(f=a[1][b],""!==f&&f.substr(0,1)!==d&&"p"===f.substr(1,1)))return!0}else{if(8>c+1&&(f=a[c+1][b],""!==f&&f.substr(0,1)!==d&&"p"===f.substr(1,1)))return!0;if(4===c&&""===a[5][b]&&(f=a[6][b],""!==f&&f.substr(0,1)!==d&&"p"===f.substr(1,1)))return!0}return!1},CHESS.util.getAttacker=function(a,b,c,d){var e,f;if(b=parseInt(b),c=parseInt(c),c>0&&b>1&&"n"===a[c-1][b-2].substr(1,1)&&a[c-1][b-2].substr(0,1)!==d)return c-1+""+(b-2);if(c>0&&6>b&&"n"===a[c-1][b+2].substr(1,1)&&a[c-1][b+2].substr(0,1)!==d)return c-1+""+(b+2);if(7>c&&b>1&&"n"===a[c+1][b-2].substr(1,1)&&a[c+1][b-2].substr(0,1)!==d)return c+1+""+(b-2);if(7>c&&6>b&&"n"===a[c+1][b+2].substr(1,1)&&a[c+1][b+2].substr(0,1)!==d)return c+1+""+(b+2);if(c>1&&b>0&&"n"===a[c-2][b-1].substr(1,1)&&a[c-2][b-1].substr(0,1)!==d)return c-2+""+(b-1);if(c>1&&7>b&&"n"===a[c-2][b+1].substr(1,1)&&a[c-2][b+1].substr(0,1)!==d)return c-2+""+(b+1);if(6>c&&b>0&&"n"===a[c+2][b-1].substr(1,1)&&a[c+2][b-1].substr(0,1)!==d)return c+2+""+(b-1);if(6>c&&7>b&&"n"===a[c+2][b+1].substr(1,1)&&a[c+2][b+1].substr(0,1)!==d)return c+2+""+(b+1);for(e=1;8>b+e;){if(f=a[c][b+e],""!==f&&f.substr(0,1)!==d&&("r"===f.substr(1,1)||"q"===f.substr(1,1)||1===e&&"k"===f.substr(1,1)))return c+""+(b+e);if(""!==f)break;e+=1}for(e=1;b-e>=0;){if(f=a[c][b-e],""!==f&&f.substr(0,1)!==d&&("r"===f.substr(1,1)||"q"===f.substr(1,1)||1===e&&"k"===f.substr(1,1)))return c+""+(b-e);if(""!==f)break;e+=1}for(e=1;c-e>=0;){if(f=a[c-e][b],""!==f&&f.substr(0,1)!==d&&("r"===f.substr(1,1)||"q"===f.substr(1,1)||1===e&&"k"===f.substr(1,1)))return c-e+""+b;if(""!==f)break;e+=1}for(e=1;8>c+e;){if(f=a[c+e][b],""!==f&&f.substr(0,1)!==d&&("r"===f.substr(1,1)||"q"===f.substr(1,1)||1===e&&"k"===f.substr(1,1)))return c+e+""+b;if(""!==f)break;e+=1}for(e=1;8>b+e&&c-e>=0;){if(f=a[c-e][b+e],""!==f&&f.substr(0,1)!==d&&("q"===f.substr(1,1)||"b"===f.substr(1,1)||1===e&&"k"===f.substr(1,1)))return c-e+""+(b+e);if(""!==f)break;e+=1}for(e=1;8>b+e&&8>c+e;){if(f=a[c+e][b+e],""!==f&&f.substr(0,1)!==d&&("q"===f.substr(1,1)||"b"===f.substr(1,1)||1===e&&"k"===f.substr(1,1)))return c+e+""+(b+e);if(""!==f)break;e+=1}for(e=1;b-e>=0&&8>c+e;){if(f=a[c+e][b-e],""!==f&&f.substr(0,1)!==d&&("q"===f.substr(1,1)||"b"===f.substr(1,1)||1===e&&"k"===f.substr(1,1)))return c+e+""+(b-e);if(""!==f)break;e+=1}for(e=1;b-e>=0&&c-e>=0;){if(f=a[c-e][b-e],""!==f&&f.substr(0,1)!==d&&("q"===f.substr(1,1)||"b"===f.substr(1,1)||1===e&&"k"===f.substr(1,1)))return c-e+""+(b-e);if(""!==f)break;e+=1}if("w"===d){if(b-1>0&&c-1>=0&&(f=a[c-1][b-1],""!==f&&f.substr(0,1)!==d&&"p"===f.substr(1,1)))return c-1+""+(b-1);if(8>b+1&&c-1>=0&&(f=a[c-1][b+1],""!==f&&f.substr(0,1)!==d&&"p"===f.substr(1,1)))return c-1+""+(b+1)}else{if(b-1>=0&&8>c+1&&(f=a[c+1][b-1],""!==f&&f.substr(0,1)!==d&&"p"===f.substr(1,1)))return c+1+""+(b-1);if(8>b+1&&8>c+1&&(f=a[c+1][b+1],""!==f&&f.substr(0,1)!==d&&"p"===f.substr(1,1)))return c+1+""+(b+1)}return""},CHESS.util.isStalemate=function(a){var b=!this.getLegalMoves(a,!0);return b},CHESS.util.isInsufficientMaterial=function(){var a=!1;return a},CHESS.util.getLegalMoves=function(a,b){var c,d,e,f,g,h,i="",j=[],k=a.white_to_move?"w":"b",l=0;for(c=0;8>c;c++)for(d=0;8>d;d++){if(e=this.reverseArrayPosition(c+""+d),a.position_array[c][d]===k+"k"&&(c>0&&(f=this.reverseArrayPosition(c-1+""+d),i=e+"-"+f,j.push(i)),c>0&&7>d&&(f=this.reverseArrayPosition(c-1+""+(d+1)),i=e+"-"+f,j.push(i)),7>d&&(f=this.reverseArrayPosition(c+""+(d+1)),i=e+"-"+f,j.push(i)),7>c&&7>d&&(f=this.reverseArrayPosition(c+1+""+(d+1)),i=e+"-"+f,j.push(i)),7>c&&(f=this.reverseArrayPosition(c+1+""+d),i=e+"-"+f,j.push(i)),7>c&&d>0&&(f=this.reverseArrayPosition(c+1+""+(d-1)),i=e+"-"+f,j.push(i)),d>0&&(f=this.reverseArrayPosition(c+""+(d-1)),i=e+"-"+f,j.push(i)),c>0&&d>0&&(f=this.reverseArrayPosition(c-1+""+(d-1)),i=e+"-"+f,j.push(i))),a.position_array[c][d].substr(0,2)===k+"p"&&(g="w"===k?-1:1,f=this.reverseArrayPosition(c+g+""+d),i=e+"-"+f,j.push(i),("w"===k&&6===c||"b"===k&&1===c)&&(f=this.reverseArrayPosition(c+2*g+""+d),i=e+"-"+f,j.push(i)),/[a-h][1-8]/.test(a.en_passant)&&(h=parseInt(this.getArrayPosition(a.en_passant).substr(0,1),10)),"w"===k&&3===c&&(h===d-1&&(f=this.reverseArrayPosition(c-1+""+(d-1)),i=e+"-"+f,j.push(i)),h===d+1&&(f=this.reverseArrayPosition(c-1+""+(d+1)),i=e+"-"+f,j.push(i))),"b"===k&&4===c&&(h===d-1&&(f=this.reverseArrayPosition(c+1+""+(d-1)),i=e+"-"+f,j.push(i)),h===d+1&&(f=this.reverseArrayPosition(c+1+""+(d+1)),i=e+"-"+f,j.push(i)))),a.position_array[c][d]===k+"q"){for(l=1;c-l>=0;)f=this.reverseArrayPosition(c-l+""+d),i=e+"-"+f,j.push(i),l++;for(l=1;c-l>=0&&7>=d+l;)f=this.reverseArrayPosition(c-l+""+(d+l)),i=e+"-"+f,j.push(i),l++;for(l=1;7>=d+l;)f=this.reverseArrayPosition(c+""+(d+l)),i=e+"-"+f,j.push(i),l++;for(l=1;7>=d+l&&7>=c+l;)f=this.reverseArrayPosition(c+l+""+(d+l)),i=e+"-"+f,j.push(i),l++;for(l=1;7>=c+l;)f=this.reverseArrayPosition(c+l+""+d),i=e+"-"+f,j.push(i),l++;for(l=1;7>=c+l&&d-l>=0;)f=this.reverseArrayPosition(c+l+""+(d-l)),i=e+"-"+f,j.push(i),l++;for(l=1;d-l>=0;)f=this.reverseArrayPosition(c+""+(d-l)),i=e+"-"+f,j.push(i),l++;for(l=1;d-l>=0&&c-l>=0;)f=this.reverseArrayPosition(c-l+""+(d-l)),i=e+"-"+f,j.push(i),l++}if(a.position_array[c][d]===k+"r"){for(l=1;c-l>=0;)f=this.reverseArrayPosition(c-l+""+d),i=e+"-"+f,j.push(i),l++;for(l=1;7>=d+l;)f=this.reverseArrayPosition(c+""+(d+l)),i=e+"-"+f,j.push(i),l++;for(l=1;7>=c+l;)f=this.reverseArrayPosition(c+l+""+d),i=e+"-"+f,j.push(i),l++;for(l=1;d-l>=0;)f=this.reverseArrayPosition(c+""+(d-l)),i=e+"-"+f,j.push(i),l++}if(a.position_array[c][d]===k+"b"){for(l=1;c-l>=0&&7>=d+l;)f=this.reverseArrayPosition(c-l+""+(d+l)),i=e+"-"+f,j.push(i),l++;for(l=1;7>=d+l&&7>=c+l;)f=this.reverseArrayPosition(c+l+""+(d+l)),i=e+"-"+f,j.push(i),l++;for(l=1;7>=c+l&&d-l>=0;)f=this.reverseArrayPosition(c+l+""+(d-l)),i=e+"-"+f,j.push(i),l++;for(l=1;d-l>=0&&c-l>=0;)f=this.reverseArrayPosition(c-l+""+(d-l)),i=e+"-"+f,j.push(i),l++}a.position_array[c][d]===k+"n"&&(c>=2&&6>=d&&(f=this.reverseArrayPosition(c-2+""+(d+1)),i=e+"-"+f,j.push(i)),c>=1&&5>=d&&(f=this.reverseArrayPosition(c-1+""+(d+2)),i=e+"-"+f,j.push(i)),6>=c&&5>=d&&(f=this.reverseArrayPosition(c+1+""+(d+2)),i=e+"-"+f,j.push(i)),5>=c&&6>=d&&(f=this.reverseArrayPosition(c+2+""+(d+1)),i=e+"-"+f,j.push(i)),5>=c&&d>=1&&(f=this.reverseArrayPosition(c+2+""+(d-1)),i=e+"-"+f,j.push(i)),6>=c&&d>=2&&(f=this.reverseArrayPosition(c+1+""+(d-2)),i=e+"-"+f,j.push(i)),c>=1&&d>=2&&(f=this.reverseArrayPosition(c-1+""+(d-2)),i=e+"-"+f,j.push(i)),c>=2&&d>=1&&(f=this.reverseArrayPosition(c-2+""+(d-1)),i=e+"-"+f,j.push(i)))}for(c=0;c<j.length;c++)if(e=j[c].split("-")[0],f=j[c].split("-")[1],this.isLegal(a,e,f)){if(b)return!0}else j.splice(c,1),c--;return b?!1:j},CHESS.util.getLongNotation=function(a,b){var c,d,e,f="",g=b.replace(/[#+=xKQRBN]/g,""),h=a.white_to_move?"w":"b",i=b.substring(0,1),j="",k="";if("O-O"===b)return"w"===h?"e1-g1":"e8-g8";if("O-O-O"===b)return"w"===h?"e1-c1":"e8-c8";for(3===g.length&&(j=g.substr(0,1),g=g.substr(g.length-2,2),/[0-9]/.test(j)?k="rank":/[a-z]/.test(j)&&(j=j.charCodeAt(0)-97,k="file")),"K"!==i&&"Q"!==i&&"W"!==i&&"R"!==i&&"B"!==i&&"N"!==i&&(i="p"),i=i.toLowerCase(),c=0;8>c;c++)for(d=0;8>d;d++)("rank"!==k||parseInt(j)===8-c)&&("file"!==k||parseInt(j)===d)&&a.position_array[c][d].length>1&&a.position_array[c][d].substr(0,2)===h+i&&(e=this.reverseArrayPosition(c+""+d),this.isLegal(a,e,g)&&(f=e+"-"+g));return f},CHESS.util.getArrayPosition=function(a){var b,c,d=!1;return/[a-h][1-8]/.test(a)&&(b=a.substr(0,1).toLowerCase(),c=a.substr(1,1),b=b.charCodeAt(0)-97,c=8-c,d=b+""+c),d},CHESS.util.reverseArrayPosition=function(a){var b=parseInt(a.substr(1,1)),c=parseInt(a.substr(0,1));return b=String.fromCharCode(b+97),c=8-c,b+""+c},CHESS.util.clonePositionArray=function(a){var b=0,c=[];for(b=0;8>b;b+=1)c[b]=a[b].slice(0);return c},CHESS.util.moveTemp=function(a,b,c){CHESS.util.move(a,b,c)},CHESS.util.move=function(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w="";return this.isLegal(a,b,c)?(void 0!==d&&(d=d.toLowerCase()),a.last_move={sq1:this.getArrayPosition(b),sq2:this.getArrayPosition(c)},a.white_to_move?(e=b,f=c,g=this.getArrayPosition(e),h=this.getArrayPosition(f),i=parseInt(g.substr(0,1)),j=parseInt(g.substr(1,1)),k=parseInt(h.substr(0,1)),l=parseInt(h.substr(1,1)),w=a.position_array[l][k],v=a.position_array[j][i],a.position_array[l][k]=a.position_array[j][i],a.position_array[j][i]="",g=this.getArrayPosition(e),a.en_passant="wp"===v.substr(0,2)&&l-j===-2?this.reverseArrayPosition(l+1+""+k):"","wp"===v.substr(0,2)&&k!==i&&""===w&&(a.position_array[j][k]="",u=f.substr(0,1)+e.substr(1,1)),"wp"===v.substr(0,2)&&0===l&&(a.position_array[l][k]="r"===d?"wq":"b"===d?"wb":"n"===d?"wn":"wq"),"wk"===v&&"e1"===e&&("g1"===f?(a.position_array[7][5]="wrk",a.position_array[7][7]=""):"c1"===f&&(a.position_array[7][3]="wrq",a.position_array[7][0]="")),"wk"===v?(a.gs_castle_kside_w=!1,a.gs_castle_qside_w=!1):"wr"===v&&"h1"===e?a.gs_castle_kside_w=!1:"wr"===v&&"a1"===e?a.gs_castle_qside_w=!1:"br"===w&&"a8"===f?a.gs_castle_qside_b=!1:"br"===w&&"h8"===f&&(a.gs_castle_kside_b=!1),a.white_to_move=!1):(m=b,n=c,o=this.getArrayPosition(m),p=this.getArrayPosition(n),q=parseInt(o.substr(0,1)),r=parseInt(o.substr(1,1)),s=parseInt(p.substr(0,1)),t=parseInt(p.substr(1,1)),w=a.position_array[t][s],v=a.position_array[r][q],a.position_array[t][s]=a.position_array[r][q],a.position_array[r][q]="",o=this.getArrayPosition(m),a.en_passant="bp"===v.substr(0,2)&&t-r===2?this.reverseArrayPosition(t-1+""+s):"","bp"===v.substr(0,2)&&s!==q&&""===w&&(a.position_array[r][s]="",u=n.substr(0,1)+m.substr(1,1)),"bp"===v.substr(0,2)&&7===t&&(a.position_array[t][s]="r"===d?"bq":"b"===d?"bb":"n"===d?"bn":"bq"),"bk"===v&&"e8"===m&&("g8"===n?(a.position_array[0][5]="brk",a.position_array[0][7]=""):"c8"===n&&(a.position_array[0][3]="brq",a.position_array[0][0]="")),"bk"===v?(a.gs_castle_kside_b=!1,a.gs_castle_qside_b=!1):"br"===v&&"h8"===m?a.gs_castle_kside_b=!1:"br"===v&&"a8"===m?a.gs_castle_qside_b=!1:"wr"===w&&"a1"===n?a.gs_castle_qside_w=!1:"wr"===w&&"h1"===n&&(a.gs_castle_kside_w=!1),a.white_to_move=!0),(this.isMate(a)||this.isStalemate(a))&&(a.active=!1),!0):!1},CHESS.Board=function(a,b){var c,d={subscribers:{any:[]}},e=CHESS.util.createPosition(),f={container:null,canvas:null,ctx:null,snapshot:null,snapshot_ctx:null,snapshot_img:new Image,square_size:0,square_color_light:"#ececd7",square_color_dark:"#7389b6",square_hover_light:"#b4d990",square_hover_dark:"#85c249",square_uri_light:new Image,square_uri_dark:new Image,dpi_ratio:1,dragok:!1,drag_piece:"",drag_clear_i:0,drag_clear_j:0,image_path:"canvaschess/img/",left:0,top:0,last_draw_left:0,last_draw_top:0,loaded_pieces:0,piece_not_lifted:!0,white_down:!0,gc_opacity:"0.8",highlight_move:!1,highlight_move_color:"#FF0000",highlight_move_opacity:"0.5",highlight_hover:!1,piece_set:"canvaschess/img/pieces/merida/",show_labels:!0,arrow_list:[],square_list:[],wp:new Image,wr:new Image,wn:new Image,wb:new Image,wq:new Image,wk:new Image,bp:new Image,br:new Image,bn:new Image,bb:new Image,bq:new Image,bk:new Image};d.myCancel=function(a){a.preventDefault(),f.dragok=!1,f.drag_piece="",f.left=0,f.top=0,f.takeSnapshot()},d.myDown=function(a){var b,c,d,g,h=f.canvas.getBoundingClientRect();if(e.active){if(a.hasOwnProperty("clientX"))f.left=a.clientX-h.left,f.top=a.clientY-h.top,f.canvas.style.cursor="move";else{if(!a.hasOwnProperty("changedTouches"))return;f.left=a.changedTouches[0].pageX-h.left,f.top=a.changedTouches[0].pageY-h.top}if(f.top=f.top*f.dpi_ratio,f.left=f.left*f.dpi_ratio,b=parseInt(f.top/f.square_size,10),c=parseInt(f.left/f.square_size,10),f.white_down||(b=7-b,c=7-c),8>b?d=e.position_array[b][c]:"setup"===e.mode&&(d=e.piecebox_array[b-8][c]),void 0===d)return void(f.active=!1);if(g=d.substr(0,1),"setup"!==e.mode&&(e.white_to_move&&"b"===g||!e.white_to_move&&"w"===g))return void(f.canvas.style.cursor="default");""!==d?(f.drag_clear_i=b,f.drag_clear_j=c,f.drag_piece=d,f.dragok=!0,f.takeSnapshot(!1)):f.canvas.style.cursor="default"}},d.myMove=function(a){a.preventDefault();var b,c,d,g,h,i,j,k,l,m,n,o,p=f,q=p.canvas.getBoundingClientRect(),r=8*p.square_size;if(p.dragok){if(b=parseInt(p.top/p.square_size,10),c=parseInt(p.left/p.square_size,10),i=(c-1)*p.square_size,j=(b-1)*p.square_size,k=3*p.square_size,l=3*p.square_size,0>b||b>7||0>c||c>7||(0>i&&(i=0),0>j&&(j=0),i+k>r&&(k=r-i),j+l>r&&(l=r-j),p.ctx.drawImage(p.snapshot,i,j,k,l,i,j,k,l)),a.hasOwnProperty("clientX"))p.left=a.clientX-q.left,p.top=a.clientY-q.top;else{if(!a.hasOwnProperty("changedTouches"))return;p.left=a.changedTouches[0].pageX-q.left,p.top=a.changedTouches[0].pageY-q.top}if(p.top=p.top*p.dpi_ratio,p.left=p.left*p.dpi_ratio,b=parseInt(p.top/p.square_size,10),c=parseInt(p.left/p.square_size,10),0>b||b>7||0>c||c>7)return;p.highlight_hover&&p.drawSquare("hover",b*p.square_size,c*p.square_size),d=b,g=c,p.white_down||(d=7-b,g=7-c),h=e.position_array[d][g].substr(0,2),""===h||d===p.drag_clear_i&&g===p.drag_clear_j||(m=parseInt(c*p.square_size,10),n=parseInt(b*p.square_size,10),p.ctx.drawImage(p[h],m,n,p.square_size,p.square_size)),h=p.drag_piece.substr(0,2),m=parseInt(p.left-p.square_size/2,10),n=parseInt(p.top-p.square_size/2,10),o=p.square_size,"setup"===e.mode&&p.top>7.5*p.square_size&&(o-=p.top-7.5*p.square_size),p.ctx.drawImage(p[h],m,n,p.square_size,o)}},d.myUp=function(a){var b,c,d,g,h,i,j,k,l,m=["a","b","c","d","e","f","g","h"],n=f.canvas.getBoundingClientRect();if(e.active&&f.dragok){if(a.hasOwnProperty("clientX"))d=(a.clientX-n.left)*f.dpi_ratio,g=(a.clientY-n.top)*f.dpi_ratio,h=parseInt(g/f.square_size,10),i=parseInt(d/f.square_size,10),f.canvas.style.cursor="default";else{if(!a.hasOwnProperty("changedTouches"))return;d=(a.changedTouches[0].pageX-n.left)*f.dpi_ratio,g=(a.changedTouches[0].pageY-n.top)*f.dpi_ratio,h=parseInt(g/f.square_size,10),i=parseInt(d/f.square_size,10)}f.white_down||(h=7-h,i=7-i),l=f.drag_piece,f.dragok=!1,f.drag_piece="",f.left=0,f.top=0,f.piece_not_lifted=!0,b=f.drag_clear_i>=8?"piecebox":m[f.drag_clear_j]+(8-f.drag_clear_i),c=h>=8?"piecebox":m[i]+(8-h),j=CHESS.util.getArrayPosition(b),k=CHESS.util.getArrayPosition(c),"setup"===e.mode?b!==c&&"piecebox"!==b&&"piecebox"!==c?(e.position_array[k.substr(1,1)][k.substr(0,1)]=l,e.position_array[j.substr(1,1)][j.substr(0,1)]=""):"piecebox"===b&&"piecebox"===c||("piecebox"===b?e.position_array[k.substr(1,1)][k.substr(0,1)]=l:"piecebox"===c&&(e.position_array[j.substr(1,1)][j.substr(0,1)]="")):e.move(b,c),f.takeSnapshot()}},d.publish=function(a,b){this.visitSubscribers("publish",a,b)},d.visitSubscribers=function(a,b,c){var d,e=c||"any",f=this.subscribers[e],g=0;for(void 0!==f&&(g=f.length),d=0;g>d;d+=1)"publish"===a?f[d](b):f[d]===b&&f.splice(d,1)},d.resize=function(a,b){var c,d,g=0,h=8,i=window.devicePixelRatio||1,j=f.ctx.webkitBackingStorePixelRatio||f.ctx.mozBackingStorePixelRatio||f.ctx.msBackingStorePixelRatio||f.ctx.oBackingStorePixelRatio||f.ctx.BackingStorePixelRatio||1;a=a||0,b=b||0,a=parseInt(a,10),b=parseInt(b,10),(0===a||0===b)&&f.canvas.parentNode&&(a=parseInt(window.getComputedStyle(f.canvas.parentNode,null).getPropertyValue("height"),10),b=parseInt(window.getComputedStyle(f.canvas.parentNode,null).getPropertyValue("width"),10)),g=b>a?a:b,"setup"===e.mode&&(h=10),f.square_size=b>a?parseInt(g/h,10):parseInt(g/8,10),f.canvas.height=f.square_size*h,f.canvas.width=8*f.square_size,f.dpi_ratio=i/j,i!==j&&(c=f.canvas.width,d=f.canvas.height,f.canvas.width=c*f.dpi_ratio,f.canvas.height=d*f.dpi_ratio,f.canvas.style.width=c+"px",f.canvas.style.height=d+"px",f.square_size=f.canvas.width/8)},e.move=function(a,b){var c,g,h,i={position_array:CHESS.util.clonePositionArray(this.position_array),white_to_move:this.white_to_move,en_passant:this.en_passant,active:this.active,gs_castle_kside_w:this.gs_castle_kside_w,gs_castle_qside_w:this.gs_castle_qside_w,gs_castle_kside_b:this.gs_castle_kside_b,gs_castle_qside_b:this.gs_castle_qside_b},j={fen:CHESS.util.getFEN(this),player_to_move:this.white_to_move?"w":"b",sq1:a,sq2:b,promote:!1,mate:!1,stalemate:!1};return this.last_move&&(i.last_move={sq1:this.last_move.sq1,sq2:this.last_move.sq2}),c=CHESS.util.getArrayPosition(a),g=CHESS.util.getArrayPosition(b),h=e.position_array[c.substr(1,1)][c.substr(0,1)].substr(1,1),"p"===h&&(e.white_to_move&&"8"===b.substr(1,1)||!e.white_to_move&&"1"===b.substr(1,1))&&(j.promote=!0),CHESS.util.move(i,a,b)?(f.arrow_list=[],CHESS.util.isMate(i)?j.mate=!0:CHESS.util.isStalemate(i)&&(j.stalemate=!0),d.publish(j,"move_before"),this.position_array=CHESS.util.clonePositionArray(i.position_array),this.white_to_move=i.white_to_move,this.en_passant=i.en_passant,this.active=i.active,this.gs_castle_kside_w=i.gs_castle_kside_w,this.gs_castle_qside_w=i.gs_castle_qside_w,this.gs_castle_kside_b=i.gs_castle_kside_b,this.gs_castle_qside_b=i.gs_castle_qside_b,this.moves+=1,i.last_move&&(this.last_move={sq1:i.last_move.sq1,sq2:i.last_move.sq2}),f.takeSnapshot(),void!this.active):void f.takeSnapshot()},e.setPosition=function(a){CHESS.util.setPosition(this,a)},f.arrowAdd=function(a,b,c,d){var e=f.hexToRgba(c);e.a=d,this.arrow_list.push({sq1:a,sq2:b,rgba:e})},f.arrowDraw=function(a,b,c){var d,e,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w=f.square_size/6,x=this.square_size/2.4,y=Math.PI/6;d=CHESS.util.getArrayPosition(a),e=CHESS.util.getArrayPosition(b),g=d.substr(0,1),h=d.substr(1,1),i=e.substr(0,1),j=e.substr(1,1),f.white_down||(g=7-g,h=7-h,i=7-i,j=7-j),g=g*this.square_size+this.square_size/2,h=h*this.square_size+this.square_size/2,i=i*this.square_size+this.square_size/2,j=j*this.square_size+this.square_size/2,g===i?(k=i,l=j>h?j-x:j+x):(m=(j-h)/(i-g),n=Math.sqrt(x*x/(1+m*m)),k=i>g?i-n:i+n,l=m*(k-i)+j),this.snapshot_ctx.beginPath(),this.snapshot_ctx.strokeStyle="rgba("+c.r+","+c.g+","+c.b+", "+c.a+")",this.snapshot_ctx.fillStyle="rgba("+c.r+","+c.g+","+c.b+", "+c.a+")",this.snapshot_ctx.lineWidth=w,this.snapshot_ctx.moveTo(g,h),this.snapshot_ctx.lineTo(k,l),this.snapshot_ctx.stroke(),o=Math.atan2(j-h,i-g),p=Math.abs(x/Math.cos(y)),q=o+Math.PI+y,r=i+Math.cos(q)*p,s=j+Math.sin(q)*p,t=o+Math.PI-y,u=i+Math.cos(t)*p,v=j+Math.sin(t)*p,this.snapshot_ctx.beginPath(),this.snapshot_ctx.lineWidth=2,this.snapshot_ctx.moveTo(u,v),this.snapshot_ctx.lineTo(r,s),this.snapshot_ctx.lineTo(i,j),this.snapshot_ctx.lineTo(u,v),this.snapshot_ctx.fill()},f.arrowDrawAll=function(){var a,b,c,d;for(a=0;a<this.arrow_list.length;a+=1)b=this.arrow_list[a].sq1,c=this.arrow_list[a].sq2,d=this.arrow_list[a].rgba,f.arrowDraw(b,c,d)},f.buildHtml=function(a){this.canvas=document.createElement("canvas"),this.canvas.className="chessboard",this.canvas.setAttribute("tabindex",0),this.ctx=this.canvas.getContext("2d"),this.snapshot=document.createElement("canvas"),this.snapshot_ctx=this.snapshot.getContext("2d"),void 0!==a&&document.getElementById(a).appendChild(this.canvas)},f.hexToRgba=function(a){var b=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;a=a.replace(b,function(a,b,c,d){return b+b+c+c+d+d});var c=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return c?{r:parseInt(c[1],16),g:parseInt(c[2],16),b:parseInt(c[3],16),a:1}:null},f.setActive=function(a){e.active=a===!0,e.active?(f.canvas.onmousedown=d.myDown,f.canvas.onmouseup=d.myUp,f.canvas.onmousemove=d.myMove,f.canvas.addEventListener("touchstart",d.myDown,!1),f.canvas.addEventListener("touchend",d.myUp,!1),f.canvas.addEventListener("touchmove",d.myMove,!1),f.canvas.addEventListener("touchleave",d.myCancel,!1),f.canvas.addEventListener("touchcancel",d.myCancel,!1)):(f.canvas.removeEventListener("touchstart",d.myDown),f.canvas.removeEventListener("touchend",d.myUp),f.canvas.removeEventListener("touchmove",d.myMove),f.canvas.removeEventListener("touchleave",d.myCancel),f.canvas.removeEventListener("touchcancel",d.myCancel))},f.squareAdd=function(a,b,c){var d=f.hexToRgba(b);d.a=c,this.square_list.push({sq:a,rgba:d})
},f.squareDraw=function(a,b){var c,d,e;c=CHESS.util.getArrayPosition(a),d=c.substr(0,1),e=c.substr(1,1),f.white_down||(d=7-d,e=7-e),this.snapshot_ctx.beginPath(),this.snapshot_ctx.fillStyle="rgba("+b.r+","+b.g+","+b.b+", "+b.a+")",this.snapshot_ctx.rect(d*this.square_size,e*this.square_size,this.square_size,this.square_size),this.snapshot_ctx.fill()},f.squareDrawAll=function(){var a,b,c;for(a=0;a<this.square_list.length;a+=1)b=this.square_list[a].sq,c=this.square_list[a].rgba,f.squareDraw(b,c)},f.drawPiece=function(a,b,c){/[bw][kqrbnp]/.test(a)&&this.snapshot_ctx.drawImage(this[a],b,c,this.square_size,this.square_size)},f.drawSquare=function(a,b,c,d){var e,f,g,h=(d||this.snapshot_ctx,parseInt(b/this.square_size,10)),i=parseInt(c/this.square_size,10),j=parseInt(this.square_size/55*13,10),k=parseInt(this.square_size/55*9,10);"hover"===a?(this.ctx.beginPath(),this.ctx.fillStyle=(h+i)%2===0?this.square_hover_light:this.square_hover_dark,this.ctx.rect(i*this.square_size,h*this.square_size,this.square_size,this.square_size),this.ctx.fill()):(e="light"===a?this.square_uri_light:this.square_uri_dark,""!==e.src?this.snapshot_ctx.drawImage(e,b,c,this.square_size,this.square_size):(this.snapshot_ctx.beginPath(),this.snapshot_ctx.fillStyle="light"===a?this.square_color_light:this.square_color_dark,this.snapshot_ctx.rect(b,c,this.square_size,this.square_size),this.snapshot_ctx.fill())),!this.show_labels||7!==i&&0!==h||(g=parseInt(this.square_size/55*12,10),this.snapshot_ctx.font=g+"px arial",this.snapshot_ctx.fillStyle=(7-i+h)%2===0?this.square_color_light:this.square_color_dark,0===h&&(f=this.white_down?8-i:i+1,this.snapshot_ctx.fillText(f,2,i*this.square_size+j)),7===i&&(f=String.fromCharCode(this.white_down?h+97:7-h+97),this.snapshot_ctx.fillText(f,this.square_size*h+this.square_size-k,8*this.square_size-2)))},f.takeSnapshot=function(a){var b,c,d,g,h,i,j,k,l,m,n=8,o=f.hexToRgba(this.highlight_move_color);for("setup"===e.mode&&(n=10),this.snapshot.width=8*this.square_size,this.snapshot.height=this.square_size*n,i=0;8>i;i+=1)for(h=0;8>h;h+=1)(h+i)%2===0&&(j=h*this.square_size,k=i*this.square_size,this.drawSquare("light",j,k));for(i=0;8>i;i+=1)for(h=0;8>h;h+=1)(h+i)%2!==0&&(j=h*this.square_size,k=i*this.square_size,this.drawSquare("dark",j,k));for(this.highlight_move&&"object"==typeof e.last_move&&void 0!==e.last_move.sq1&&(this.snapshot_ctx.beginPath(),this.snapshot_ctx.fillStyle="rgba("+o.r+","+o.g+","+o.b+", "+this.highlight_move_opacity+")",h=e.last_move.sq1.substr(0,1),i=e.last_move.sq1.substr(1,1),this.white_down||(h=7-h,i=7-i),this.snapshot_ctx.rect(h*this.square_size,i*this.square_size,this.square_size,this.square_size),h=e.last_move.sq2.substr(0,1),i=e.last_move.sq2.substr(1,1),this.white_down||(h=7-h,i=7-i),this.snapshot_ctx.rect(h*this.square_size,i*this.square_size,this.square_size,this.square_size),this.snapshot_ctx.fill()),this.squareDrawAll(),b=0;8>b;b+=1)for(c=0;8>c;c+=1)this.dragok&&b===this.drag_clear_i&&c===this.drag_clear_j||(l=e.position_array[b][c].substr(0,2),d=b,g=c,this.white_down||(d=7-b,g=7-c),h=g*this.square_size,i=d*this.square_size,""!==l&&this.drawPiece(l,h,i));if("setup"===e.mode)for(b=0;2>b;b+=1)for(c=0;8>c;c+=1)l=e.piecebox_array[b][c].substr(0,2),h=c*this.square_size,i=(b+8)*this.square_size,""!==l&&this.drawPiece(l,h,i);this.dragok&&(b=this.drag_clear_i,c=this.drag_clear_j,this.white_down||(b=7-this.drag_clear_i,c=7-this.drag_clear_j),m=(b+c)%2===0,m?""!==this.square_uri_light.src?this.drawSquare("light",c*this.square_size,b*this.square_size,this.ctx):(this.snapshot_ctx.beginPath(),this.snapshot_ctx.fillStyle=this.square_color_light,this.snapshot_ctx.rect(c*this.square_size,b*this.square_size,this.square_size,this.square_size),this.snapshot_ctx.fill()):""!==this.square_uri_dark.src?this.drawSquare("dark",c*this.square_size,b*this.square_size,this.ctx):(this.snapshot_ctx.beginPath(),this.snapshot_ctx.fillStyle=this.square_color_dark,this.snapshot_ctx.rect(c*this.square_size,b*this.square_size,this.square_size,this.square_size),this.snapshot_ctx.fill())),this.arrowDrawAll(),void 0===a&&(a=!0),a&&(this.ctx.clearRect(0,8*this.square_size,8*this.square_size,2*this.square_size),this.ctx.drawImage(this.snapshot,0,0))},this.addArrow=function(a,b,c,d){d=parseFloat(d),d=d>=0&&1>=d?d:f.gc_opacity,d=d>=0&&1>=d?d:1,f.arrowAdd(a,b,c,d),f.takeSnapshot()},this.addSquare=function(a,b,c){c=parseFloat(c),c=c>=0&&1>=c?c:f.gc_opacity,c=c>=0&&1>=c?c:1,f.squareAdd(a,b,c),f.takeSnapshot()},this.display=function(){f.takeSnapshot()},this.flip=function(a){f.white_down="w"===a?!0:"b"===a?!1:!f.white_down,f.takeSnapshot()},this.getActiveColor=function(){return e.white_to_move?"w":"b"},this.getFEN=function(){return CHESS.util.getFEN(e)},this.getCanvas=function(){return f.canvas},this.getImage=function(){var a=new Image;return a.src=f.canvas.toDataURL("image/png"),a},this.isInsufficientMaterial=function(){return CHESS.util.isInsufficientMaterial(e)},this.isMate=function(){return CHESS.util.isMate(e)},this.isStalemate=function(){return CHESS.util.isStalemate(e)},this.move=function(a){var b,c,d;b=CHESS.util.getLongNotation(e,a),b=b.split("-"),c=b[0],d=b[1],e.move(c,d)},this.positionClear=function(){e.position_array=[["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""]],e.last_move={},e.en_passant="",e.white_to_move=!0,e.gs_castle_kside_w=!0,e.gs_castle_qside_w=!0,e.gs_castle_kside_b=!0,e.gs_castle_qside_b=!0,e.moves=0,f.takeSnapshot()},this.positionStart=function(){e.position_array=[["br","bn","bb","bq","bk","bb","bn","br"],["bp","bp","bp","bp","bp","bp","bp","bp"],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["wp","wp","wp","wp","wp","wp","wp","wp"],["wr","wn","wb","wq","wk","wb","wn","wr"]],e.last_move={},e.en_passant="",e.white_to_move=!0,e.gs_castle_kside_w=!0,e.gs_castle_qside_w=!0,e.gs_castle_kside_b=!0,e.gs_castle_qside_b=!0,e.moves=0,f.takeSnapshot()},this.removeArrow=function(){f.arrow_list.pop(),f.takeSnapshot()},this.removeAllArrows=function(){f.arrow_list=[],f.takeSnapshot()},this.removeSquare=function(){f.square_list.pop(),f.takeSnapshot()},this.removeAllSquares=function(){f.square_list=[],f.takeSnapshot()},this.resize=function(a,b){d.resize(a,b),f.takeSnapshot()},this.setActive=function(a){f.setActive(a)},this.setLastMove=function(a,b){a=CHESS.util.getArrayPosition(a),b=CHESS.util.getArrayPosition(b),e.last_move={sq1:a,sq2:b}},this.setMode=function(a){e.mode=a,d.resize(f.canvas.height,f.canvas.width),f.takeSnapshot()},this.setPosition=function(a){e.setPosition(a),f.takeSnapshot()},this.subscribe=function(a,b){a=a||"any",void 0===d.subscribers[a]&&(d.subscribers[a]=[]),d.subscribers[a].push(b)},this.unsubscribe=function(a,b){d.visitSubscribers("unsubscribe",a,b)},(c=function(){function c(){"function"==typeof b&&12===f.loaded_pieces&&b()}var g;f.buildHtml(a.container),f.highlight_move=a.highlight_move===!0?!0:!1,f.highlight_hover=a.highlight_hover===!0?!0:!1,f.show_labels=a.show_labels===!1?!1:!0,f.square_color_light=a.square_color_light?a.square_color_light:f.square_color_light,f.square_color_dark=a.square_color_dark?a.square_color_dark:f.square_color_dark,f.gc_opacity=a.gc_opacity?a.gc_opacity:f.gc_opacity,f.highlight_move_color=a.highlight_move_color?a.highlight_move_color:f.highlight_move_color,f.highlight_move_opacity=a.highlight_move_opacity?a.highlight_move_opacity:f.highlight_move_opacity,f.square_hover_light=a.square_hover_light?a.square_hover_light:f.square_hover_light,f.square_hover_dark=a.square_hover_dark?a.square_hover_dark:f.square_hover_dark,f.piece_set=a.piece_set?a.piece_set:f.piece_set,e.mode=a.mode,e.setPosition(a.fen?a.fen:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"),d.resize(a.height,a.width),g=f.piece_set.replace(/\/$/,""),f.wp.src=g+"/wp.svg",f.wp.onload=function(){f.loaded_pieces+=1,12===f.loaded_pieces&&f.takeSnapshot()},f.wr.src=g+"/wr.svg",f.wr.onload=function(){f.loaded_pieces+=1,12===f.loaded_pieces&&(f.takeSnapshot(),c())},f.wn.src=g+"/wn.svg",f.wn.onload=function(){f.loaded_pieces+=1,12===f.loaded_pieces&&(f.takeSnapshot(),c())},f.wb.src=g+"/wb.svg",f.wb.onload=function(){f.loaded_pieces+=1,12===f.loaded_pieces&&(f.takeSnapshot(),c())},f.wq.src=g+"/wq.svg",f.wq.onload=function(){f.loaded_pieces+=1,12===f.loaded_pieces&&(f.takeSnapshot(),c())},f.wk.src=g+"/wk.svg",f.wk.onload=function(){f.loaded_pieces+=1,12===f.loaded_pieces&&(f.takeSnapshot(),c())},f.bp.src=g+"/bp.svg",f.bp.onload=function(){f.loaded_pieces+=1,12===f.loaded_pieces&&(f.takeSnapshot(),c())},f.br.src=g+"/br.svg",f.br.onload=function(){f.loaded_pieces+=1,12===f.loaded_pieces&&(f.takeSnapshot(),c())},f.bn.src=g+"/bn.svg",f.bn.onload=function(){f.loaded_pieces+=1,12===f.loaded_pieces&&(f.takeSnapshot(),c())},f.bb.src=g+"/bb.svg",f.bb.onload=function(){f.loaded_pieces+=1,12===f.loaded_pieces&&(f.takeSnapshot(),c())},f.bq.src=g+"/bq.svg",f.bq.onload=function(){f.loaded_pieces+=1,12===f.loaded_pieces&&(f.takeSnapshot(),c())},f.bk.src=g+"/bk.svg",f.bk.onload=function(){f.loaded_pieces+=1,12===f.loaded_pieces&&(f.takeSnapshot(),c())},"string"==typeof a.square_uri_dark&&(f.square_uri_dark.src=a.square_uri_dark,f.square_uri_dark.onload=function(){f.takeSnapshot()}),"string"==typeof a.square_uri_light&&(f.square_uri_light.src=a.square_uri_light,f.square_uri_light.onload=function(){f.takeSnapshot()})})()},"function"==typeof define&&define.amd&&define("chess",[],function(){return CHESS});
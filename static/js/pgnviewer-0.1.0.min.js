CHESS.PgnViewer=function(a){var b,c={},d={black:"",date:"",event:"",result:"",round:"",site:"",white:"",fen:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",game_list:[]},e={board:null,board_control_box:null,container:null,control_box:null,control_end_elem:null,control_next_elem:null,control_pause_elem:null,control_play_elem:null,control_prev_elem:null,control_start_elem:null,current_move:null,download_btn:null,flip_board_btn:null,game_list:null,header_box:null,header_date_elem:null,header_details_box:null,header_event_elem:null,header_players_elem:null,header_result_elem:null,header_site_elem:null,main_box:null,move_control_box:null,move_list:null,ply:0,screen:null,start_end_variation:!1};c.goEnd=function(){null!==e.current_move&&e.changeMove(e.current_move.parentNode.lastChild)},c.goNext=function(){var a;null!==e.current_move&&(a=e.getSiblingMove(e.current_move,1),e.changeMove(a))},c.goPrev=function(){var a;null!==e.current_move&&(a=e.getSiblingMove(e.current_move,-1),e.changeMove(a))},c.goStart=function(){null!==e.current_move&&e.changeMove(e.current_move.parentNode.firstChild)},c.updateBoard=function(a){var b,c,d;if(e.board.setPosition(a.currentTarget.fen),e.board.setLastMove(a.currentTarget.move.sq1,a.currentTarget.move.sq2),e.board.removeAllArrows(),e.board.removeAllSquares(),"object"==typeof a.currentTarget.gc){if(c=a.currentTarget.gc,c.arrows.length>=1)for(b=0;b<c.arrows.length;b+=1)d="R"===c.arrows[b].color?"#F00":"Y"===c.arrows[b].color?"#FF0":"#0F0",e.board.addArrow(c.arrows[b].sq1,c.arrows[b].sq2,d);if(c.squares.length>=1)for(b=0;b<c.squares.length;b+=1)d="R"===c.squares[b].color?"#F00":"Y"===c.squares[b].color?"#FF0":"#0F0",e.board.addSquare(c.squares[b].sq,d)}e.board.display(),null!==e.current_move&&e.current_move.removeAttribute("class"),a.currentTarget.className="current",e.current_move=a.currentTarget},e.buildHtml=function(a,b){var c=document;void 0!==a.id&&(this.container=c.getElementById(a.id)),(void 0===this.container||null===this.container)&&(c.write("<div id='canvaschess' class='canvaschesspgn'></div>"),this.container=c.getElementById("canvaschess"),this.container.removeAttribute("id")),a.mobile&&this.container.classList.add("mobile"),this.container.setAttribute("tabindex",0),this.main_box=c.createElement("div"),this.main_box.className="pgn_main_box",this.container.appendChild(this.main_box),this.buildHtmlHeader(),this.buildHtmlControls(),this.main_box.appendChild(b),this.move_list=c.createElement("ol"),this.move_list.className="move_list",this.main_box.appendChild(this.move_list),a.show_screen!==!1&&this.buildHtmlScreen(),this.resize()},e.buildHtmlControls=function(){var a=document;this.control_box=a.createElement("div"),this.control_box.className="pgn_control_box",this.container.appendChild(this.control_box),this.board_control_box=a.createElement("span"),this.board_control_box.className="board_controls",this.control_box.appendChild(this.board_control_box),this.flip_board_btn=a.createElement("a"),this.flip_board_btn.className="board_ctrl_btn board_flip",this.flip_board_btn.title="Flip",this.flip_board_btn.onclick=this.board.flip,this.download_btn=a.createElement("a"),this.download_btn.className="board_ctrl_btn board_download",this.download_btn.title="Download PGN",this.board_control_box.appendChild(this.flip_board_btn),this.board_control_box.appendChild(this.download_btn),this.move_control_box=a.createElement("span"),this.move_control_box.className="move_controls",this.control_box.appendChild(this.move_control_box),this.control_play_elem=a.createElement("a"),this.control_play_elem.className="pgn_ctrl_btn pgn_play",this.control_play_elem.title="Play",this.control_play_elem.onclick=c.goPlay,this.control_pause_elem=a.createElement("a"),this.control_pause_elem.className="pgn_ctrl_btn pgn_pause",this.control_pause_elem.title="Pause",this.control_pause_elem.onclick=c.goPause,this.control_start_elem=a.createElement("a"),this.control_start_elem.className="pgn_ctrl_btn pgn_start",this.control_start_elem.title="Start",this.control_start_elem.onclick=c.goStart,this.control_prev_elem=a.createElement("a"),this.control_prev_elem.className="pgn_ctrl_btn pgn_prev",this.control_prev_elem.title="Previous",this.control_prev_elem.onclick=c.goPrev,this.control_next_elem=a.createElement("a"),this.control_next_elem.className="pgn_ctrl_btn pgn_next",this.control_next_elem.title="Next",this.control_next_elem.onclick=c.goNext,this.control_end_elem=a.createElement("a"),this.control_end_elem.className="pgn_ctrl_btn pgn_end",this.control_end_elem.title="End",this.control_end_elem.onclick=c.goEnd,this.move_control_box.appendChild(this.control_start_elem),this.move_control_box.appendChild(this.control_prev_elem),this.move_control_box.appendChild(this.control_next_elem),this.move_control_box.appendChild(this.control_end_elem)},e.buildHtmlHeader=function(){var a=document;this.header_box=a.createElement("div"),this.header_box.className="pgn_header_box",this.container.insertBefore(this.header_box,this.container.firstChild),this.header_box.style.opacity="0",this.header_details_box=a.createElement("div"),this.header_details_box.className="pgn_header_details_box",this.header_box.appendChild(this.header_details_box),this.header_players_elem=a.createElement("span"),this.header_players_elem.className="pgn_players",this.header_players_elem.title="Players",this.header_players_elem.innerHTML="&nbsp;",this.header_event_elem=a.createElement("span"),this.header_event_elem.className="pgn_event",this.header_event_elem.title="Event",this.header_event_elem.innerHTML="&nbsp;",this.header_site_elem=a.createElement("span"),this.header_site_elem.className="pgn_site",this.header_site_elem.title="Site",this.header_date_elem=a.createElement("span"),this.header_date_elem.className="pgn_date",this.header_date_elem.title="Date",this.header_result_elem=a.createElement("span"),this.header_result_elem.className="pgn_result",this.header_result_elem.title="Result",this.header_details_box.appendChild(this.header_players_elem),this.header_details_box.appendChild(this.header_event_elem),this.header_details_box.appendChild(this.header_site_elem),this.header_details_box.appendChild(this.header_date_elem),this.header_details_box.appendChild(this.header_result_elem),this.game_list=a.createElement("select"),this.game_list.className="game_list",this.game_list.onchange=function(a){e.changeGame(a.currentTarget.value)},this.header_box.appendChild(this.game_list)},e.buildHtmlScreen=function(){var a=document;this.screen=a.createElement("div"),this.screen.className="pgn_screen",this.container.insertBefore(this.screen,this.container.firstChild),e.move_list.style.overflowY="hidden",this.screen.onclick=function(a){a.preventDefault(),a.currentTarget.style.display="none",e.move_list.style.overflowY="scroll"}},e.changeGame=function(a){var b,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t={comment:"",gc:null};for(d.event="",d.site="",d.date="",d.round="",d.white="",d.black="",d.result="",d.fen="";this.move_list.firstChild;)this.move_list.removeChild(this.move_list.firstChild);for(this.current_move=null,g=d.game_list[a],h=g.match(/\[([^\[%]+)\]/g),b=0;b<h.length;b+=1)switch(i=h[b].match(/\[(\S+)\s"(.*)"\]/),i[1]=i[1].replace(/\s+$/,""),i[2]=i[2].replace(/\s+$/,""),i[1].toLowerCase()){case"event":d.event=i[2];break;case"site":d.site=i[2];break;case"date":d.date=i[2];break;case"round":d.round=i[2];break;case"white":d.white=i[2];break;case"black":d.black=i[2];break;case"result":d.result=i[2];break;case"fen":d.fen=i[2]}for(""===d.fen&&(d.fen="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"),this.displayHeader(),j=g.match(/\]\s+([{\w][\s\S]+$)/)[1],j=j.replace(/\s*1-0\s*$/,""),j=j.replace(/\s*0-1\s*$/,""),j=j.replace(/\s*1\/2-1\/2\s*$/,""),j=j.replace(/\s*\*\s*$/,""),r=j.match(/\{[^{]*\}/g),j=j.replace(/\{[^{]*\}/g,"{}"),k=j.match(/^(\{\})|(\d+[.]{1,3}).+?(?=(\d+[.]{1,3})|$)/g),"{}"===k[0]&&(t=this.getComment(r),this.move(null,t.comment,null,t.gc),t.comment="",t.gc=null),b=0;b<k.length;b+=1)if(l=k[b].match(/\d+[.]{1,3}\s?((?:[^ )]+)\s?(?:\$[\d]+)?)\s?(?:\{\})?/),null!==l){if(o=l[1].match(/([!?=]+)\s*$/),o=o&&o[0]?o[0]:null,n=l[1].match(/\$(\d+)/),n=n&&n[1]?n[1]:null,null!==n&&(p=CHESS.nag_code[n],p&&(n=/\.svg/.test(p.symbol)?"<span class='nagcode nagsvg nag"+n+"' title='"+p.desc+"'>&nbsp;</span>":"<span class='nagcode' title='"+p.desc+"'>"+p.symbol+"</span>")),q=n?n:o?o:"",l[1]=l[1].replace(/[^1-8a-hRNBQKOx\-]*$/,""),l[1]=l[1].replace(/\s*\$.*$/,""),l[1]=l[1].replace(/[^1-8a-hRNBQKOx\-]*$/,""),/\{\}/.test(l[0])&&(t=this.getComment(r)),this.move(l[1],t.comment,q,t.gc),t.comment="",t.gc=null,k[b]=k[b].replace(l[0],""),m=k[b].match(/((?:\w[^ )]+)\s?(?:\$[\d]+)?)\s?(?:\{\})?/),null!==m&&(o=m[1].match(/([!?=]+)\s*$/),o=o&&o[0]?o[0]:null,n=m[1].match(/\$(\d+)/),n=n&&n[1]?n[1]:null,null!==n&&(p=CHESS.nag_code[n],p&&(n=p&&/\.svg/.test(p.symbol)?"<span class='nagcode nagsvg nag"+n+"' title='"+p.desc+"'>&nbsp;</span>":"<span class='nagcode' title='"+p.desc+"'>"+p.symbol+"</span>")),q=n?n:o?o:"",m[1]=m[1].replace(/[^1-8a-hRNBQKOx\-]*$/,""),m[1]=m[1].replace(/\s*\$.*$/,""),/\{\}/.test(m[0])&&(t=this.getComment(r)),this.move(m[1],t.comment,q,t.gc),t.comment="",t.gc=null),/\)/.test(k[b]))for(s=k[b].match(/\)/g).length,f=0;s>f;f+=1)this.endVariation();if(/\(/.test(k[b])&&(this.startVariation(),/\(\s?\{\}/.test(k[b]))){t=this.getComment(r);var u=document.createElement("li");u.move="";var v=document.createElement("span");v.setAttribute("class","comment"),v.innerHTML=t.comment,u.appendChild(v),void 0!==t.gc&&null!==t.gc&&(u.gc=t.gc),u.setAttribute("data-ply",this.ply),u.fen=e.getSiblingMove(this.current_move.parentNode.previousSibling,-1).fen,u.onclick=c.updateBoard,this.current_move.appendChild(u),t.comment="",t.gc=null}}this.current_move=e.move_list.getElementsByTagName("li")[0],this.board.setPosition(this.current_move.fen),c.updateBoard({currentTarget:this.current_move}),e.move_list.scrollTop=0},e.getComment=function(a){var b,c,d,e,f,g,h,i={comment:"",gc:{arrows:[],squares:[]}};if(i.comment=a.shift().replace(/\{/,"").replace(/\}/,""),/\[%cal/.test(i.comment)){for(c=i.comment.match(/\[%cal (?:[GYR]\w{2}\w{2},?\s*)+\]/)[0],d=c.match(/[GYR]\w{2}\w{2},?\s*/g),b=0;b<d.length;b+=1)e=d[b].match(/([GYR])(\w{2})(\w{2}),?\s*/),f=e[1],g=e[2],h=e[3],i.gc.arrows.push({color:f,sq1:g,sq2:h});i.comment=i.comment.replace(c,"")}if(/\[%csl/.test(i.comment)){for(c=i.comment.match(/\[%csl (?:[GYR]\w{2},?\s*)+\]/)[0],d=c.match(/[GYR]\w{2},?\s*/g),b=0;b<d.length;b+=1)e=d[b].match(/([GYR])(\w{2}),?\s*/),f=e[1],g=e[2],i.gc.squares.push({color:f,sq:g});i.comment=i.comment.replace(c,"")}return i.comment=i.comment.replace(/^\s+|\s+$/g,""),i},e.changeMove=function(a){var b;e.current_move!==a&&(null!==e.current_move&&null!==a&&e.current_move.removeAttribute("class"),null!==a&&(a.className="current",c.updateBoard({currentTarget:a}),e.current_move=a,b=e.current_move.offsetTop,b-=parseInt(e.move_list.offsetHeight/2,10),e.move_list.scrollTop=b))},e.displayHeader=function(){a.show_tags===!1?this.header_details_box.style.display="none":(this.header_date_elem.innerHTML=this.getPgnDate(d.date),this.header_players_elem.innerHTML=d.white+" vs "+d.black,this.header_event_elem.innerHTML=d.event,this.header_site_elem.innerHTML=d.site,this.header_result_elem.innerHTML=d.result),this.header_box.style.opacity="1"},e.endVariation=function(){return this.current_move=this.current_move.parentNode.parentNode.previousSibling,this.ply=+this.current_move.getAttribute("data-ply"),this.start_end_variation=!0,this},e.getPgnDate=function(a){var b,c=["","Jan","Feb","Mar","Apr","May","Jun","Jul","Jun","Sep","Oct","Nov","Dec"],d=a.split("."),e="",f="",g="";return 3===d.length&&4===d[0].length&&2===d[1].length&&2===d[2].length&&(e=d[0],f=parseInt(d[1],10),g=parseInt(d[2],10),f=f>0&&13>f?c[f]:"",b=(g>0?g+" ":"")+(""!==f?f+" ":"")+(e>0?e+" ":""),b=b.replace(/\s+$/,"")),b},e.getSiblingMove=function(a,b){if(1===b)for(;(a=a.nextSibling)&&/variation_list/.test(a.className););else if(-1===b)for(;(a=a.previousSibling)&&/variation_list/.test(a.className););return a},e.importFile=function(a){var b,c,e,f,g,h,i;if(a=a.replace(/^ +/gm,"").replace(/$ +/gm,""),a=a.replace(/\n/g," ").replace(/\s+/g," "),d.game_list=a.split(/[^\w](?:(?:1-0)|(?:0-1)|(?:1\/2-1\/2)|\*)\s*(?=\[)/),d.game_list.length>1)for(b=0;b<d.game_list.length;b+=1)c=d.game_list[b],e=c.match(/\[\s*white\s+['"](.*?)['"]\]/i),e=null!==e&&e.length>1?e[1]:"",f=c.match(/\[\s*black\s+['"](.*?)['"]\]/i),f=null!==f&&f.length>1?f[1]:"",g=c.match(/\[\s*date\s+['"]([0-9.?]+)['"]\]/i),g=null!==g&&g.length>1?g[1]:"",h=e+" vs. "+f,i=document.createElement("option"),i.value=b,i.text=h,this.game_list.appendChild(i);else this.game_list.style.display="none";this.changeGame(0)},e.move=function(b,f,g,h){var i,j,k,l,m,n,o,p,q,r,s,t,u="";if(!b&&!f&&!h)return this;if(null===this.current_move&&(i=document.createElement("li"),d.fen.length>0?(i.fen=d.fen,r=i.fen.match(/\s+([wbWB])\s+([-kqKQ]+)\s+([-\w]{1,2})\s+(\d+)\s+(\d+)\s*$/),s=r[1].toLowerCase(),m=+r[5],this.ply=2*m-("w"===s?2:1),i.setAttribute("data-ply",this.ply)):i.setAttribute("data-ply",0),i.move="",i.onclick=c.updateBoard,this.move_list.appendChild(i),this.current_move=i,!b&&"string"==typeof f))return l=document.createElement("span"),l.setAttribute("class","comment"),l.innerHTML=f,i.appendChild(l),void(void 0!==h&&null!==h&&(i.gc=h));if(m=this.ply%2===0?parseInt(this.ply/2,10)+1+".&nbsp;":"",this.ply%2!==1||"b"!==s&&!this.start_end_variation||(m=parseInt((this.ply-1)/2,10)+1+"..."),this.start_end_variation=!1,this.ply+=1,k=b,a.figurine!==!1)switch(b.charAt(0)){case"K":k="<span class='figurine fig_k'>K</span>"+b.substring(1);break;case"Q":k="<span class='figurine fig_q'>Q</span>"+b.substring(1);break;case"R":k="<span class='figurine fig_r'>R</span>"+b.substring(1);break;case"B":k="<span class='figurine fig_b'>B</span>"+b.substring(1);break;case"N":k="<span class='figurine fig_n'>N</span>"+b.substring(1)}return j=document.createElement("span"),j.setAttribute("class","move_text"),i=document.createElement("li"),i.setAttribute("data-ply",this.ply),i.appendChild(j),void 0===this.current_move.fen?"variation"===this.current_move.className&&(n=e.getSiblingMove(this.current_move.parentNode.previousSibling,-1).fen):n=this.current_move.fen,o=CHESS.util.createPosition(n),p=CHESS.util.getLongNotation(o,b),q=p.split("-"),/=[QRBN]/.test(b)&&(t=b.match(/=([QRBN])/)[1]),CHESS.util.move(o,q[0],q[1],t),n=CHESS.util.getFEN(o),CHESS.util.isCheck(o.position_array,o.white_to_move?"w":"b")&&(u="+",CHESS.util.isMate(o)&&(u="#")),j.innerHTML=m+k+u+" "+g+" ",i.move={sq1:q[0],sq2:q[1]},i.fen=n,void 0!==h&&null!==h&&(i.gc=h),i.onclick=c.updateBoard,"ol"===this.current_move.tagName.toLowerCase()?this.current_move.appendChild(i):this.current_move.parentNode.appendChild(i),f&&(l=document.createElement("span"),l.setAttribute("class","comment"),l.innerHTML=f,i.appendChild(l)),this.current_move=i,this},e.resize=function(){var b,c,d,f,g,h,i,j,k,l,m=window,n=document,o=n.documentElement,p=n.getElementsByTagName("body")[0],q=m.innerWidth||o.clientWidth||p.clientWidth,r=m.innerHeight||o.clientHeight||p.clientHeight,s=this.container.getBoundingClientRect();if(h=.5,void 0!==a.ratio&&(i=a.ratio.split(":"),2===i.length&&(i[0]=parseInt(i[0],10),i[1]=parseInt(i[1],10),0!==i[1]&&(h=i[0]/(i[0]+i[1]),h>3?h=3:.3>h&&(h=.3)))),d=parseInt(a.width*h,10),null!==this.screen&&(j=d/2-65,k=j+this.header_box.clientHeight,this.screen.style.backgroundPosition=j+"px "+k+"px"),void 0===a.responsive&&(a.responsive=!0),a.responsive&&a.width+s.left>q&&r>q)c=d,this.container.style.width=c+"px",this.header_details_box.style.width=c+"px",this.game_list.style.width=c+"px",this.move_list.style.width="",this.move_control_box.style.width=c+"px",this.container.classList.add("mobile"),r<2*d+this.control_box.clientHeight+this.header_box.clientHeight?(l=r-(d+this.control_box.clientHeight+this.header_box.clientHeight+20),100>l&&(l=100),this.move_list.style.height=l+"px"):this.move_list.style.height="";else{if(a.move_list_width=parseInt(a.width,10)-d,this.container.style.width=a.width+"px",this.header_details_box.style.width=d+"px",null!==a.move_list_width)for(this.game_list.style.width=a.move_list_width+"px",this.move_list.style.width=a.move_list_width-30+"px",this.move_list.style.height=8*parseInt(d/8,10)+"px",this.move_control_box.style.width=a.move_list_width+"px",f=document.getElementsByClassName("pgn_ctrl_btn"),g=parseInt((a.move_list_width-120)/8,10),b=0;b<f.length;b+=1)f[b].style.margin="0 "+g+"px";this.container.classList.remove("mobile")}e.board.resize(d,d)},e.startVariation=function(){var a,b;return null===this.current_move.nextSibling?(a=document.createElement("li"),a.setAttribute("class","variation_list")):a=this.current_move.nextSibling,b=document.createElement("ol"),b.setAttribute("class","variation"),a.appendChild(b),this.current_move.parentNode.appendChild(a),this.current_move=b,this.ply-=1,this.start_end_variation=!0,this},this.flip=function(){e.board.flip()},this.load=function(a,b){var c=new XMLHttpRequest;e.download_btn.href=a,c.onreadystatechange=function(){var a;4===c.readyState&&200===c.status&&(a=c.responseText,e.importFile(a),"function"==typeof b&&b())},c.open("GET",a,!0),c.send()},this.loadText=function(a){e.importFile(a)},(b=function(b){a.pgn_uri=a.pgn_uri||a.url,a.square_uri_dark=a.square_uri_dark||a.square_dark,a.square_uri_light=a.square_uri_light||a.square_light,window.onresize=function(){e.resize()},window.addEventListener("touchend",function(){e.resize()},!1),a.width=parseInt(a.width,10)||600,e.board=new CHESS.Board({height:a.board_width,width:a.board_width,square_color_light:a.square_color_light,square_color_dark:a.square_color_dark,square_hover_dark:a.square_hover_dark,square_hover_light:a.square_hover_light,square_uri_dark:a.square_uri_dark,square_uri_light:a.square_uri_light,gc_opacity:a.gc_opacity,highlight_move:a.highlight_move,highlight_move_color:a.highlight_move_color,highlight_move_opacity:a.highlight_move_opacity,show_labels:a.show_labels,piece_set:a.piece_set}),e.board.setActive(!1),e.buildHtml(a,e.board.getCanvas()),e.container.onkeydown=function(a){a.stopPropagation(),37===a.keyCode?c.goPrev():39===a.keyCode&&c.goNext()},e.container.getElementsByClassName("chessboard")[0].addEventListener("keydown",function(a){a.stopPropagation(),37===a.keyCode?c.goPrev():39===a.keyCode&&c.goNext()}),void 0!==a.pgn_uri?b.load(a.pgn_uri):void 0!==a.pgn_text&&b.loadText(a.pgn_text)})(this)};